id: plurk

db:
  - version: 1
    schema:
      users: id, nickname, display_name
      plurks: id, user_id
      responses: id, user_id, plurk_id

extractors:
  main_page_user:
    url: https://www.plurk.com/:user_name
    steps:
      - use: response
        type: text
      - use: re
        pattern: 'var GLOBAL=([^\n]+);?\n'
        template: $1
      - use: json_parse
        unwrap_new_date: true
      - use: json_get
        path: page_user
      - use: store
        table: users
        method: put

  main_page_pinned_plurks:
    url: https://www.plurk.com/:user_name
    steps:
      - use: response
        type: text
      - use: re
        pattern: 'PINNED_PLURK = ([^\n]+);\n'
        template: $1
      - use: json_parse
        unwrap_new_date: true
      - use: store
        table: plurks
        method: putMany

  main_page_plurks:
    url: https://www.plurk.com/:user_name
    steps:
      - use: response
        type: text
      - use: re
        pattern: 'PUBLIC_PLURKS = ([^\n]+);\n'
        template: $1
      - use: json_parse
        unwrap_new_date: true
      - use: store
        table: plurks
        method: putMany

  api_get_plurks:
    url: https://www.plurk.com/TimeLine/getPlurks
    steps:
      - use: response
        type: json
      - use: json_get
        path: plurks
      - use: store
        table: plurks
        method: putMany

  api_responses:
    url: https://www.plurk.com/v2/plurk/:plurk_id/responses/seen
    steps:
      - use: response
        type: json
      - use: json_get
        path: responses
      - use: store
        table: responses
        method: putMany

  api_responses_users:
    url: https://www.plurk.com/v2/plurk/:plurk_id/responses/seen
    steps:
      - use: response
        type: json
      - use: json_get
        path: users
      - use: store
        table: users
        method: putMany

  plurk_page_user:
    url: 'https://www.plurk.com/p/:plurk_id((?!getzone)\w+)'
    steps:
      - use: response
        type: text
      - use: re
        pattern: 'var GLOBAL=([^\n]+);?\n'
        template: $1
      - use: json_parse
        unwrap_new_date: true
      - use: json_get
        path: page_user
      - use: store
        table: users
        method: put

  plurk_page_plurk:
    url: 'https://www.plurk.com/p/:plurk_id((?!getzone)\w+)'
    steps:
      - use: response
        type: text
      - use: re
        pattern: 'plurk = ([^\n]+);\n'
        template: $1
      - use: json_parse
        unwrap_new_date: true
      - use: store
        table: plurks
        method: put

exporters:
  plurks:
    type: media
    steps:
      - use: store
        table: plurks
        method: getAll
      - use: table_join
        table: users
        left_key: user_id
        right_key: id
        fields:
          nick_name: nick_name
          display_name: display_name
      - use: for_each
        steps:
          - use: date
            input: posted
            output: posted_date
          - use: re
            input: content_raw
            pattern: URL
            all: true
            output: media_urls
          - use: filter
            input: media_urls
            condition: IS_IMAGE
            output: media_urls
          - use: export
            input: media_urls
            default_ext: jpg
            filename: '{plurk_id}_{nick_name}_{index}_{posted_date:%y%m%d}{ext}'

  responses:
    type: media
    steps:
      - use: store
        table: responses
        method: getAll
      - use: table_join
        table: users
        left_key: user_id
        right_key: id
        fields:
          nick_name: nick_name
          display_name: display_name
      - use: for_each
        steps:
          - use: date
            input: posted
            output: posted_date
          - use: re
            input: content_raw
            pattern: URL
            all: true
            output: media_urls
          - use: filter
            input: media_urls
            condition: IS_IMAGE
            output: media_urls
          - use: export
            input: media_urls
            default_ext: jpg
            filename: '{plurk_id}_r_{id}_{nick_name}_{index}_{posted_date:%y%m%d}{ext}'

